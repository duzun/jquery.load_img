{"version":3,"file":"load_img.js","sources":["../load_img.js"],"sourcesContent":["/**\n *  Load images asynchronously and cache them.\n *\n *  @license MIT\n *  @git https://github.com/duzun/jquery.load_img\n *  @author Dumitru Uzun (DUzun.Me)\n *  @version 1.5.1\n */\n\n// ---------------------------------------------------------------------------\nconst VERSION   = '1.5.1';\n\ninit.VERSION = VERSION;\n\nexport default function init($, global) {\n    global = typeof globalThis != 'undefined' ? globalThis : window;\n\n        var undefined; //jshint ignore:line\n\n        // ---------------------------------------------------------------------------\n        const { document } = global\n        ,   cache = {}\n        ,   errors = {}\n        ;\n\n        /**\n         * Load an image to cache.\n         *\n         * @param string src - source URL of the iamge\n         * @param callback clb.call(img: $(Image), src|false, event: $.Event)\n         *\n         * @return $(Image) element\n         */\n        function load_img(src, options, clb) {\n            if(!clb && typeof options == 'function') {\n                clb = options;\n                options = undefined;\n            }\n\n            options = options ? $.extend({}, load_img.settings, options) : load_img.settings;\n\n            var img = $('<img />')\n            ,   hasClb = 'function' == typeof clb\n            ,   defered = hasClb ? undefined : new $.Deferred()\n            ,   onEvent = function (evt) {\n                    var type = evt.type\n                    ,   error = type == 'error'\n                    ;\n\n                    if (!evt.timeStamp) {\n                        evt.timeStamp = Date.now();\n                    }\n                    evt.src = src;\n                    if(error) {\n                        errors[src] = evt;\n                    }\n                    else {\n                        delete errors[src];\n                    }\n                    cache[src] = !error;\n                    img.off(error ? 'load' : 'error', onEvent).remove();\n                    img.show();\n                    if(hasClb) {\n                        clb.call(img, error?false:src, evt);\n                    }\n                    else if ( defered ) {\n                        if ( error ) {\n                            defered.reject(evt);\n                        }\n                        else {\n                            defered.resolve(evt, src);\n                        }\n                    }\n                }\n            ,   that = this\n            ,   ctx = that && that != $ && that.$ctx\n            ;\n\n            if ( defered ) {\n                img.then = $.proxy(defered.then, defered);\n                img.promise = $.proxy(defered.promise, defered);\n            }\n\n            img\n                .hide()\n                .one('load', onEvent)\n                .one('error', onEvent)\n            ;\n\n            let errorEvt = errors[src];\n            const { errorExpires } = options;\n            if (errorEvt && errorExpires && errorExpires < Date.now() - errorEvt.timeStamp) {\n                errorEvt = undefined;\n            }\n\n            if (errorEvt) {\n                img.prop('src', src).trigger(errorEvt);\n            }\n            else {\n                if(!ctx || !ctx.length || ctx[0] == document) {\n                    ctx = $(document.body||'body');\n                }\n                if(!ctx.length) {\n                    var tio = setInterval(function () {\n                        if(document.body) {\n                            clearInterval(tio);\n                            ctx = $(document.body);\n                            img.prop('src', src);\n                            ctx.append(img);\n                        }\n                    }, 50);\n                }\n                else {\n                    img.prop('src', src);\n                    ctx.append(img);\n                }\n            }\n            return img;\n        }\n\n        /**\n         * Check whether src has beed loaded (either success or error)\n         *\n         * @param string src - source URL of the iamge\n         *\n         * @return bool true if src in cache, false otherwise\n         */\n        function inCache(src) {\n            return src in cache;\n        }\n\n        /**\n         * Check whether image with src exists.\n         *\n         * @param string src - source URL of the iamge\n         * @param callback cb(src|false)\n         *\n         * Note: If cb supplied and src not in cache, it will trigger\n         *\n         * @return bool|undefined true if exists (and cached), false if doesn't exist (error on load), undefined if never loaded (not in cache)\n         */\n        function exists(src, cb) {\n            if ( src in cache ) {\n                cb && cb(cache[src]&&src);\n                return cache[src];\n            }\n            else {\n                cb && load_img(src, cb);\n            }\n        }\n\n        function isImgOk(img) {\n            if ( !img.complete ) return false; /* Only IE is correct here */\n            if ( typeof img.naturalWidth != 'undefined' && img.naturalWidth == 0 ) return false; /* Other Browsers */\n            return true; /* No other way of checking: assume it's ok. */\n        }\n\n        /**\n         * Purce the cache.\n         */\n        function purgeCache() {\n            $.each(cache, function (n,v) {\n                delete cache[n];\n            });\n\n            $.each(errors, function (n,v) {\n                delete errors[n];\n            });\n        }\n\n        // Export\n\n        load_img.exists      = exists;\n        load_img.inCache     = load_img.in_cache    = inCache;\n        load_img.isImgOk     = load_img.is_ok       = isImgOk;\n        load_img.purgeCache  = load_img.purge_cache = purgeCache;\n\n        load_img.cache       = cache;\n        load_img.errors      = errors;\n        load_img.VERSION     = VERSION;\n\n        load_img.settings = {\n            errorExpires: 1e3, // after how many milliseconds to allow to retry loading an image which errored\n        };\n\n        return $.load_img = load_img;\n}\n\n;(function (global) {\n    const $ = global.jQuery || global.Zepto;\n    if ($) init($, global);\n}(typeof globalThis != 'undefined' ? globalThis : typeof window != 'undefined' ? window : global));\n"],"names":["VERSION","init","$","global","globalThis","window","undefined","document","cache","errors","load_img","src","options","clb","extend","settings","img","hasClb","defered","Deferred","onEvent","evt","type","error","timeStamp","Date","now","off","remove","show","call","reject","resolve","that","ctx","$ctx","then","proxy","promise","hide","one","errorEvt","errorExpires","prop","trigger","length","body","tio","setInterval","clearInterval","append","inCache","exists","cb","isImgOk","complete","naturalWidth","purgeCache","each","n","v","in_cache","is_ok","purge_cache","jQuery","Zepto"],"mappings":";;;;;;IAAA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IAEA;IACA,IAAMA,OAAO,GAAK,OAAlB,CAAA;IAEAC,IAAI,CAACD,OAAL,GAAeA,OAAf,CAAA;IAEe,SAASC,IAAT,CAAcC,CAAd,EAAiBC,MAAjB,EAAyB;MACpCA,MAAM,GAAG,OAAOC,UAAP,IAAqB,WAArB,GAAmCA,UAAnC,GAAgDC,MAAzD,CAAA;MAEI,IAAIC,WAAJ,CAHgC;IAKhC;;IACA,EAAA,IAAA,OAAA,GAAqBH,MAArB;UAAQI,QAAR,WAAQA,QAAR;UACIC,KADJ,GACY,EADZ;UAEIC,MAFJ,GAEa,EAFb,CAAA;IAKA;IACR;IACA;IACA;IACA;IACA;IACA;IACA;;IACQ,EAAA,SAASC,QAAT,CAAkBC,GAAlB,EAAuBC,OAAvB,EAAgCC,GAAhC,EAAqC;IACjC,IAAA,IAAG,CAACA,GAAD,IAAQ,OAAOD,OAAP,IAAkB,UAA7B,EAAyC;IACrCC,MAAAA,GAAG,GAAGD,OAAN,CAAA;IACAA,MAAAA,OAAO,GAAGN,WAAV,CAAA;IACH,KAAA;;IAEDM,IAAAA,OAAO,GAAGA,OAAO,GAAGV,CAAC,CAACY,MAAF,CAAS,EAAT,EAAaJ,QAAQ,CAACK,QAAtB,EAAgCH,OAAhC,CAAH,GAA8CF,QAAQ,CAACK,QAAxE,CAAA;;IAEA,IAAA,IAAIC,GAAG,GAAGd,CAAC,CAAC,SAAD,CAAX;IAAA,QACIe,MAAM,GAAG,UAAc,IAAA,OAAOJ,GADlC;YAEIK,OAAO,GAAGD,MAAM,GAAGX,WAAH,GAAe,IAAIJ,CAAC,CAACiB,QAAN,EAFnC;IAAA,QAGIC,OAAO,GAAG,SAAVA,OAAU,CAAUC,GAAV,EAAe;IACrB,MAAA,IAAIC,IAAI,GAAGD,GAAG,CAACC,IAAf;IAAA,UACIC,KAAK,GAAGD,IAAI,IAAI,OADpB,CAAA;;IAIA,MAAA,IAAI,CAACD,GAAG,CAACG,SAAT,EAAoB;IAChBH,QAAAA,GAAG,CAACG,SAAJ,GAAgBC,IAAI,CAACC,GAAL,EAAhB,CAAA;IACH,OAAA;;UACDL,GAAG,CAACV,GAAJ,GAAUA,GAAV,CAAA;;IACA,MAAA,IAAGY,KAAH,EAAU;IACNd,QAAAA,MAAM,CAACE,GAAD,CAAN,GAAcU,GAAd,CAAA;IACH,OAFD,MAGK;YACD,OAAOZ,MAAM,CAACE,GAAD,CAAb,CAAA;IACH,OAAA;;IACDH,MAAAA,KAAK,CAACG,GAAD,CAAL,GAAa,CAACY,KAAd,CAAA;UACAP,GAAG,CAACW,GAAJ,CAAQJ,KAAK,GAAG,MAAH,GAAY,OAAzB,EAAkCH,OAAlC,CAAA,CAA2CQ,MAA3C,EAAA,CAAA;IACAZ,MAAAA,GAAG,CAACa,IAAJ,EAAA,CAAA;;IACA,MAAA,IAAGZ,MAAH,EAAW;YACPJ,GAAG,CAACiB,IAAJ,CAASd,GAAT,EAAcO,KAAK,GAAC,KAAD,GAAOZ,GAA1B,EAA+BU,GAA/B,CAAA,CAAA;WADJ,MAGK,IAAKH,OAAL,EAAe;IAChB,QAAA,IAAKK,KAAL,EAAa;cACTL,OAAO,CAACa,MAAR,CAAeV,GAAf,CAAA,CAAA;IACH,SAFD,MAGK;IACDH,UAAAA,OAAO,CAACc,OAAR,CAAgBX,GAAhB,EAAqBV,GAArB,CAAA,CAAA;IACH,SAAA;IACJ,OAAA;SA/BT;YAiCIsB,IAAI,GAAG,IAjCX;YAkCIC,GAAG,GAAGD,IAAI,IAAIA,IAAI,IAAI/B,CAAhB,IAAqB+B,IAAI,CAACE,IAlCpC,CAAA;;IAqCA,IAAA,IAAKjB,OAAL,EAAe;IACXF,MAAAA,GAAG,CAACoB,IAAJ,GAAWlC,CAAC,CAACmC,KAAF,CAAQnB,OAAO,CAACkB,IAAhB,EAAsBlB,OAAtB,CAAX,CAAA;IACAF,MAAAA,GAAG,CAACsB,OAAJ,GAAcpC,CAAC,CAACmC,KAAF,CAAQnB,OAAO,CAACoB,OAAhB,EAAyBpB,OAAzB,CAAd,CAAA;IACH,KAAA;;IAEDF,IAAAA,GAAG,CACEuB,IADL,EAEKC,CAAAA,GAFL,CAES,MAFT,EAEiBpB,OAFjB,CAGKoB,CAAAA,GAHL,CAGS,OAHT,EAGkBpB,OAHlB,CAAA,CAAA;IAMA,IAAA,IAAIqB,QAAQ,GAAGhC,MAAM,CAACE,GAAD,CAArB,CAAA;IACA,IAAA,IAAA,QAAA,GAAyBC,OAAzB;YAAQ8B,YAAR,YAAQA,YAAR,CAAA;;IACA,IAAA,IAAID,QAAQ,IAAIC,YAAZ,IAA4BA,YAAY,GAAGjB,IAAI,CAACC,GAAL,EAAA,GAAae,QAAQ,CAACjB,SAArE,EAAgF;IAC5EiB,MAAAA,QAAQ,GAAGnC,WAAX,CAAA;IACH,KAAA;;IAED,IAAA,IAAImC,QAAJ,EAAc;UACVzB,GAAG,CAAC2B,IAAJ,CAAS,KAAT,EAAgBhC,GAAhB,CAAA,CAAqBiC,OAArB,CAA6BH,QAA7B,CAAA,CAAA;IACH,KAFD,MAGK;IACD,MAAA,IAAG,CAACP,GAAD,IAAQ,CAACA,GAAG,CAACW,MAAb,IAAuBX,GAAG,CAAC,CAAD,CAAH,IAAU3B,QAApC,EAA8C;YAC1C2B,GAAG,GAAGhC,CAAC,CAACK,QAAQ,CAACuC,IAAT,IAAe,MAAhB,CAAP,CAAA;IACH,OAAA;;IACD,MAAA,IAAG,CAACZ,GAAG,CAACW,MAAR,EAAgB;IACZ,QAAA,IAAIE,GAAG,GAAGC,WAAW,CAAC,YAAY;cAC9B,IAAGzC,QAAQ,CAACuC,IAAZ,EAAkB;gBACdG,aAAa,CAACF,GAAD,CAAb,CAAA;IACAb,YAAAA,GAAG,GAAGhC,CAAC,CAACK,QAAQ,CAACuC,IAAV,CAAP,CAAA;IACA9B,YAAAA,GAAG,CAAC2B,IAAJ,CAAS,KAAT,EAAgBhC,GAAhB,CAAA,CAAA;gBACAuB,GAAG,CAACgB,MAAJ,CAAWlC,GAAX,CAAA,CAAA;IACH,WAAA;aANgB,EAOlB,EAPkB,CAArB,CAAA;IAQH,OATD,MAUK;IACDA,QAAAA,GAAG,CAAC2B,IAAJ,CAAS,KAAT,EAAgBhC,GAAhB,CAAA,CAAA;YACAuB,GAAG,CAACgB,MAAJ,CAAWlC,GAAX,CAAA,CAAA;IACH,OAAA;IACJ,KAAA;;IACD,IAAA,OAAOA,GAAP,CAAA;IACH,GAAA;IAED;IACR;IACA;IACA;IACA;IACA;IACA;;;MACQ,SAASmC,OAAT,CAAiBxC,GAAjB,EAAsB;QAClB,OAAOA,GAAG,IAAIH,KAAd,CAAA;IACH,GAAA;IAED;IACR;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;;;IACQ,EAAA,SAAS4C,MAAT,CAAgBzC,GAAhB,EAAqB0C,EAArB,EAAyB;QACrB,IAAK1C,GAAG,IAAIH,KAAZ,EAAoB;UAChB6C,EAAE,IAAIA,EAAE,CAAC7C,KAAK,CAACG,GAAD,CAAL,IAAYA,GAAb,CAAR,CAAA;UACA,OAAOH,KAAK,CAACG,GAAD,CAAZ,CAAA;IACH,KAHD,MAIK;IACD0C,MAAAA,EAAE,IAAI3C,QAAQ,CAACC,GAAD,EAAM0C,EAAN,CAAd,CAAA;IACH,KAAA;IACJ,GAAA;;MAED,SAASC,OAAT,CAAiBtC,GAAjB,EAAsB;IAClB,IAAA,IAAK,CAACA,GAAG,CAACuC,QAAV,EAAqB,OAAO,KAAP,CAAA;IAAc;;IACnC,IAAA,IAAK,OAAOvC,GAAG,CAACwC,YAAX,IAA2B,WAA3B,IAA0CxC,GAAG,CAACwC,YAAJ,IAAoB,CAAnE,EAAuE,OAAO,KAAP,CAAA;IAAc;;IACrF,IAAA,OAAO,IAAP,CAAA;IAAa;IAChB,GAAA;IAED;IACR;IACA;;;IACQ,EAAA,SAASC,UAAT,GAAsB;QAClBvD,CAAC,CAACwD,IAAF,CAAOlD,KAAP,EAAc,UAAUmD,CAAV,EAAYC,CAAZ,EAAe;UACzB,OAAOpD,KAAK,CAACmD,CAAD,CAAZ,CAAA;SADJ,CAAA,CAAA;QAIAzD,CAAC,CAACwD,IAAF,CAAOjD,MAAP,EAAe,UAAUkD,CAAV,EAAYC,CAAZ,EAAe;UAC1B,OAAOnD,MAAM,CAACkD,CAAD,CAAb,CAAA;SADJ,CAAA,CAAA;IAGH,GA1J+B;;;MA8JhCjD,QAAQ,CAAC0C,MAAT,GAAuBA,MAAvB,CAAA;IACA1C,EAAAA,QAAQ,CAACyC,OAAT,GAAuBzC,QAAQ,CAACmD,QAAT,GAAuBV,OAA9C,CAAA;IACAzC,EAAAA,QAAQ,CAAC4C,OAAT,GAAuB5C,QAAQ,CAACoD,KAAT,GAAuBR,OAA9C,CAAA;IACA5C,EAAAA,QAAQ,CAAC+C,UAAT,GAAuB/C,QAAQ,CAACqD,WAAT,GAAuBN,UAA9C,CAAA;MAEA/C,QAAQ,CAACF,KAAT,GAAuBA,KAAvB,CAAA;MACAE,QAAQ,CAACD,MAAT,GAAuBA,MAAvB,CAAA;MACAC,QAAQ,CAACV,OAAT,GAAuBA,OAAvB,CAAA;MAEAU,QAAQ,CAACK,QAAT,GAAoB;QAChB2B,YAAY,EAAE,GADE;;OAApB,CAAA;IAIA,EAAA,OAAOxC,CAAC,CAACQ,QAAF,GAAaA,QAApB,CAAA;IACP,CAAA;;IAEC,CAAA,UAAUP,MAAV,EAAkB;MAChB,IAAMD,CAAC,GAAGC,MAAM,CAAC6D,MAAP,IAAiB7D,MAAM,CAAC8D,KAAlC,CAAA;IACA,EAAA,IAAI/D,CAAJ,EAAOD,IAAI,CAACC,CAAD,EAAIC,MAAJ,CAAJ,CAAA;IACV,CAHC,EAGA,OAAOC,UAAP,IAAqB,WAArB,GAAmCA,UAAnC,GAAgD,OAAOC,MAAP,IAAiB,WAAjB,GAA+BA,MAA/B,GAAwCF,MAHxF,CAAD;;;;;;;;"}