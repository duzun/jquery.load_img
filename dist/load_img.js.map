{"version":3,"file":"load_img.js","sources":["../load_img.js"],"sourcesContent":["/**\n *  Load images asynchronously and cache them.\n *\n *  @license MIT\n *  @git https://github.com/duzun/jquery.load_img\n *  @author Dumitru Uzun (DUzun.Me)\n *  @version 1.5.2\n */\n\n// ---------------------------------------------------------------------------\nconst VERSION   = '1.5.2';\n\ninit.VERSION = VERSION;\n\nexport default function init($, global) {\n        if (!global) global = getGlobal();\n\n        var undefined; //jshint ignore:line\n\n        // ---------------------------------------------------------------------------\n        const { document } = global\n        ,   cache = {}\n        ,   errors = {}\n        ;\n\n        /**\n         * Load an image to cache.\n         *\n         * @param string src - source URL of the iamge\n         * @param callback clb.call(img: $(Image), src|false, event: $.Event)\n         *\n         * @return $(Image) element\n         */\n        function load_img(src, options, clb) {\n            if(!clb && typeof options == 'function') {\n                clb = options;\n                options = undefined;\n            }\n\n            options = options ? $.extend({}, load_img.settings, options) : load_img.settings;\n\n            var img = $('<img />')\n            ,   hasClb = 'function' == typeof clb\n            ,   defered = hasClb ? undefined : new $.Deferred()\n            ,   onEvent = function (evt) {\n                    var type = evt.type\n                    ,   error = type == 'error'\n                    ;\n\n                    if (!evt.timeStamp) {\n                        evt.timeStamp = Date.now();\n                    }\n                    evt.src = src;\n                    if(error) {\n                        errors[src] = evt;\n                    }\n                    else {\n                        delete errors[src];\n                    }\n                    cache[src] = !error;\n                    img.off(error ? 'load' : 'error', onEvent).remove();\n                    img.show();\n                    if(hasClb) {\n                        clb.call(img, error?false:src, evt);\n                    }\n                    else if ( defered ) {\n                        if ( error ) {\n                            defered.reject(evt);\n                        }\n                        else {\n                            defered.resolve(evt, src);\n                        }\n                    }\n                }\n            ,   that = this\n            ,   ctx = that && that != $ && that.$ctx\n            ;\n\n            if ( defered ) {\n                defered.promise(img);\n            }\n\n            img\n                .hide()\n                .one('load', onEvent)\n                .one('error', onEvent)\n            ;\n\n            let errorEvt = errors[src];\n            const { errorExpires } = options;\n            if (errorEvt && errorExpires && errorExpires < Date.now() - errorEvt.timeStamp) {\n                errorEvt = undefined;\n            }\n\n            if (errorEvt) {\n                img.prop('src', src).trigger(errorEvt);\n            }\n            else {\n                if(!ctx || !ctx.length || ctx[0] == document) {\n                    ctx = $(document.body||'body');\n                }\n                if(!ctx.length) {\n                    var tio = setInterval(function () {\n                        if(document.body) {\n                            clearInterval(tio);\n                            ctx = $(document.body);\n                            img.prop('src', src);\n                            ctx.append(img);\n                        }\n                    }, 50);\n                }\n                else {\n                    img.prop('src', src);\n                    ctx.append(img);\n                }\n            }\n            return img;\n        }\n\n        /**\n         * Check whether src has beed loaded (either success or error)\n         *\n         * @param string src - source URL of the iamge\n         *\n         * @return bool true if src in cache, false otherwise\n         */\n        function inCache(src) {\n            return src in cache;\n        }\n\n        /**\n         * Check whether image with src exists.\n         *\n         * @param string src - source URL of the iamge\n         * @param callback cb(src|false)\n         *\n         * Note: If cb supplied and src not in cache, it will trigger\n         *\n         * @return bool|undefined true if exists (and cached), false if doesn't exist (error on load), undefined if never loaded (not in cache)\n         */\n        function exists(src, cb) {\n            if ( src in cache ) {\n                cb && cb(cache[src]&&src);\n                return cache[src];\n            }\n            else {\n                cb && load_img(src, cb);\n            }\n        }\n\n        function loadSrc(src, options) {\n\n            if (exists(src)) {\n                let defered = $.Deferred();\n                let promise = defered.promise();\n                defered.resolve(src);\n                return promise;\n            }\n\n            return load_img(src, options)\n            .then((evt) => {\n                const { src, target } = evt;\n                return src || target && target.src;\n            });\n        }\n\n        function isImgOk(img) {\n            if ( !img.complete ) return false; /* Only IE is correct here */\n            if ( typeof img.naturalWidth != 'undefined' && img.naturalWidth == 0 ) return false; /* Other Browsers */\n            return true; /* No other way of checking: assume it's ok. */\n        }\n\n        /**\n         * Purce the cache.\n         */\n        function purgeCache() {\n            $.each(cache, function (n,v) {\n                delete cache[n];\n            });\n\n            $.each(errors, function (n,v) {\n                delete errors[n];\n            });\n        }\n\n        // Export\n\n        load_img.exists      = exists;\n        load_img.src         = loadSrc;\n        load_img.inCache     = load_img.in_cache    = inCache;\n        load_img.isImgOk     = load_img.is_ok       = isImgOk;\n        load_img.purgeCache  = load_img.purge_cache = purgeCache;\n\n        load_img.cache       = cache;\n        load_img.errors      = errors;\n        load_img.VERSION     = VERSION;\n\n        load_img.settings = {\n            errorExpires: 1e3, // after how many milliseconds to allow to retry loading an image which errored\n        };\n\n        return $.load_img = load_img;\n}\n\nfunction getGlobal() {\n    return typeof globalThis != 'undefined' ? globalThis : typeof window != 'undefined' ? window : global;\n}\n\n;(function (global) {\n    const $ = global.jQuery || global.Zepto;\n    if ($) init($, global);\n}(getGlobal()));\n"],"names":["VERSION","init","$","global","getGlobal","undefined","document","cache","errors","load_img","src","options","clb","extend","settings","img","hasClb","defered","Deferred","onEvent","evt","type","error","timeStamp","Date","now","off","remove","show","call","reject","resolve","that","ctx","$ctx","promise","hide","one","errorEvt","errorExpires","prop","trigger","length","body","tio","setInterval","clearInterval","append","inCache","exists","cb","loadSrc","then","target","isImgOk","complete","naturalWidth","purgeCache","each","n","v","in_cache","is_ok","purge_cache","globalThis","window","jQuery","Zepto"],"mappings":"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"}